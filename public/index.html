<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Global Chat</title>
<style>
  html, body { height: 100%; margin:0; font-family: Arial; display:flex; flex-direction:column; align-items:center; }
  #chatContainer { flex:1; width:90%; max-width:800px; display:flex; flex-direction:column; margin-top:20px; }
  #chat { flex:1; width:100%; border:1px solid #ccc; padding:10px; overflow-y:auto; background:#f9f9f9; margin-bottom:10px; box-sizing:border-box; }
  #inputContainer { display:flex; width:100%; gap:10px; }
  #msg { flex:1; padding:8px; }
  #sendBtn { padding:8px 12px; }
  #loginSection { width:90%; max-width:800px; display:flex; flex-direction:column; justify-content:center; gap:10px; margin-top:20px; flex-wrap:wrap; }
  #name,#lang,#langSearch { padding:8px; flex:1 1 150px; }
  button { cursor:pointer; }
  .system-msg { font-style:italic; color:#555; }
</style>
</head>
<body>

<h2>Global Chat</h2>

<div id="loginSection">
  <input id="name" placeholder="Enter username" />
  <input id="langSearch" placeholder="Search language..." oninput="filterLanguages()" />
  <select id="lang" size="10" style="width:100%;"></select>
  <button onclick="join()">Join</button>
</div>

<div id="chatContainer">
  <div id="chat"></div>
  <div id="inputContainer">
    <input id="msg" placeholder="Message" disabled />
    <button id="sendBtn" onclick="send()" disabled>Send</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let socket;
let loggedIn = false;
let myLang = "en";

// Full language list with ISO 639-1 codes
const languages = {
  "af": "Afrikaans","sq": "Albanian","am": "Amharic","ar": "Arabic","hy": "Armenian",
  "az": "Azerbaijani","eu": "Basque","be": "Belarusian","bn": "Bengali","bs": "Bosnian",
  "bg": "Bulgarian","ca": "Catalan","ceb": "Cebuano","ny": "Chichewa","zh": "Chinese",
  "co": "Corsican","hr": "Croatian","cs": "Czech","da": "Danish","nl": "Dutch","en": "English",
  "eo": "Esperanto","et": "Estonian","tl": "Filipino","fi": "Finnish","fr": "French",
  "fy": "Frisian","gl": "Galician","ka": "Georgian","de": "German","el": "Greek",
  "gu": "Gujarati","ht": "Haitian Creole","ha": "Hausa","haw": "Hawaiian","he": "Hebrew",
  "hi": "Hindi","hmn": "Hmong","hu": "Hungarian","is": "Icelandic","ig": "Igbo",
  "id": "Indonesian","ga": "Irish","it": "Italian","ja": "Japanese","jw": "Javanese",
  "kn": "Kannada","kk": "Kazakh","km": "Khmer","ko": "Korean","ku": "Kurdish","ky": "Kyrgyz",
  "lo": "Lao","la": "Latin","lv": "Latvian","lt": "Lithuanian","lb": "Luxembourgish",
  "mk": "Macedonian","mg": "Malagasy","ms": "Malay","ml": "Malayalam","mt": "Maltese",
  "mi": "Maori","mr": "Marathi","mn": "Mongolian","my": "Myanmar (Burmese)","ne": "Nepali",
  "no": "Norwegian","ps": "Pashto","fa": "Persian","pl": "Polish","pt": "Portuguese",
  "pa": "Punjabi","ro": "Romanian","ru": "Russian","sm": "Samoan","gd": "Scots Gaelic",
  "sr": "Serbian","st": "Sesotho","sn": "Shona","sd": "Sindhi","si": "Sinhala","sk": "Slovak",
  "sl": "Slovenian","so": "Somali","es": "Spanish","su": "Sundanese","sw": "Swahili",
  "sv": "Swedish","tg": "Tajik","ta": "Tamil","te": "Telugu","th": "Thai","tr": "Turkish",
  "uk": "Ukrainian","ur": "Urdu","uz": "Uzbek","vi": "Vietnamese","cy": "Welsh","xh": "Xhosa",
  "yi": "Yiddish","yo": "Yoruba","zu": "Zulu"
};

// Populate language select
const langSelect = document.getElementById("lang");
function populateLanguages() {
  langSelect.innerHTML = "";
  for (const [code, name] of Object.entries(languages)) {
    const option = document.createElement("option");
    option.value = code;
    option.textContent = name;
    langSelect.appendChild(option);
  }
}
populateLanguages();

// Filter languages based on search input
function filterLanguages() {
  const query = document.getElementById("langSearch").value.toLowerCase();
  langSelect.innerHTML = "";
  for (const [code, name] of Object.entries(languages)) {
    if (name.toLowerCase().includes(query)) {
      const option = document.createElement("option");
      option.value = code;
      option.textContent = name;
      langSelect.appendChild(option);
    }
  }
}

function join() {
  const name = document.getElementById("name").value.trim();
  myLang = langSelect.value;
  if(!name || !myLang) return alert("Enter username and select language");

  socket = io();

  socket.emit("choose_username", { name, lang: myLang }, res => {
    if(!res.ok) return alert(res.error);

    loggedIn = true;
    document.getElementById("msg").disabled = false;
    document.getElementById("sendBtn").disabled = false;
    document.getElementById("loginSection").style.display = "none";
    appendSystem(`Joined as ${name}`);
  });

  socket.on("chat_history", msgs => {
    msgs.forEach(m => appendMessage(m.user, m.text));
  });

  socket.on("chat_message", m => appendMessage(m.user, m.text));
}

function send() {
  const msgInput = document.getElementById("msg");
  const msg = msgInput.value.trim();
  if(!msg || !loggedIn) return;
  socket.emit("send_message", { text: msg });
  msgInput.value = "";
}

function appendMessage(user, text) {
  const chatDiv = document.getElementById("chat");
  const div = document.createElement("div");
  if(user === "SYSTEM") {
    div.className = "system-msg";
    div.textContent = text;
  } else {
    div.innerHTML = `<strong>${user}:</strong> ${text}`;
  }
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function appendSystem(text) {
  const chatDiv = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = "system-msg";
  div.textContent = text;
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}
</script>

</body>
</html>
