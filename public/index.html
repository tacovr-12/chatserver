<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Global Chat</title>
<style>
  /* Basic reset */
  html, body {
    height: 100%;
    margin: 0;
    font-family: Arial, sans-serif;
    width: 100%;
    background: #f0f2f5;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  h2 {
    margin-top: 20px;
    color: #333;
  }

  /* Login section */
  #loginSection {
    width: 80%;
    max-width: 1200px;
    display: flex;
    justify-content: flex-start;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
    align-items: center;
  }

  #loginSection input, #loginSection select {
    padding: 10px;
    flex: 1 1 200px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  #loginSection button {
    padding: 10px 20px;
    border: none;
    background-color: #007bff;
    color: white;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
  }

  #loginSection button:hover {
    background-color: #0056b3;
  }

  /* Search input for languages */
  #langSearch {
    flex: 1 1 200px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  /* Chat container */
  #chatContainer {
    flex: 1;
    width: 90%;
    max-width: 1200px;
    display: flex;
    flex-direction: column;
    margin: 20px auto;
    min-height: 500px;
  }

  #chat {
    flex: 1;
    width: 100%;
    border: 1px solid #ccc;
    padding: 15px;
    overflow-y: auto;
    background: #fff;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #inputContainer {
    display: flex;
    width: 100%;
    gap: 10px;
    margin-top: 10px;
  }

  #msg {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  #sendBtn {
    padding: 10px 20px;
    border: none;
    background-color: #28a745;
    color: white;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
  }

  #sendBtn:hover {
    background-color: #1e7e34;
  }

  .system-msg {
    font-style: italic;
    color: #555;
  }

  /* Language options dropdown */
  #lang {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    flex: 1 1 200px;
  }
</style>
</head>
<body>

<h2>Global Chat</h2>

<div id="loginSection">
  <input id="name" placeholder="Enter username" />
  <input id="langSearch" placeholder="Search language..." oninput="filterLanguages()" />
  <select id="lang">
    <!-- Full language list will be populated by JS -->
  </select>
  <button onclick="join()">Join</button>
</div>

<div id="chatContainer">
  <div id="chat"></div>
  <div id="inputContainer">
    <input id="msg" placeholder="Message" disabled />
    <button id="sendBtn" onclick="send()" disabled>Send</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let socket;
let loggedIn = false;
let myLang = "en";

// Full language list (ISO 639-1 codes)
const languages = [
  { code: "en", name: "English" },
  { code: "ja", name: "Japanese" },
  { code: "de", name: "German" },
  { code: "es", name: "Spanish" },
  { code: "fr", name: "French" },
  { code: "zh", name: "Chinese" },
  { code: "ar", name: "Arabic" },
  { code: "ru", name: "Russian" },
  { code: "pt", name: "Portuguese" },
  { code: "hi", name: "Hindi" },
  { code: "it", name: "Italian" },
  { code: "ko", name: "Korean" },
  { code: "tr", name: "Turkish" },
  { code: "sv", name: "Swedish" },
  { code: "nl", name: "Dutch" },
  { code: "pl", name: "Polish" },
  { code: "vi", name: "Vietnamese" },
  { code: "th", name: "Thai" },
  { code: "id", name: "Indonesian" },
  // ... Add 200+ languages here if needed
];

// Populate language dropdown
const langSelect = document.getElementById("lang");
function populateLanguages(list) {
  langSelect.innerHTML = "";
  list.forEach(l => {
    const opt = document.createElement("option");
    opt.value = l.code;
    opt.textContent = l.name;
    langSelect.appendChild(opt);
  });
}
populateLanguages(languages);

// Filter languages by search
function filterLanguages() {
  const search = document.getElementById("langSearch").value.toLowerCase();
  const filtered = languages.filter(l => l.name.toLowerCase().includes(search));
  populateLanguages(filtered);
}

function join() {
  const name = document.getElementById("name").value.trim();
  myLang = document.getElementById("lang").value;
  if (!name) return alert("Enter a username");

  socket = io();

  socket.emit("choose_username", { name, lang: myLang }, res => {
    if (!res.ok) return alert(res.error);

    loggedIn = true;
    document.getElementById("msg").disabled = false;
    document.getElementById("sendBtn").disabled = false;
    document.getElementById("loginSection").style.display = "none";
    appendSystem(`Joined as ${name}`);
  });

  socket.on("chat_history", msgs => {
    msgs.forEach(m => appendMessage(m.user, m.text));
  });

  socket.on("chat_message", m => appendMessage(m.user, m.text));
}

function send() {
  const msgInput = document.getElementById("msg");
  const msg = msgInput.value.trim();
  if (!msg || !loggedIn) return;
  socket.emit("send_message", { text: msg, lang: myLang });
  msgInput.value = "";
}

function appendMessage(user, text) {
  const chatDiv = document.getElementById("chat");
  const div = document.createElement("div");
  if (user === "SYSTEM") {
    div.className = "system-msg";
    div.textContent = text;
  } else {
    div.innerHTML = `<strong>${user}:</strong> ${text}`;
  }
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function appendSystem(text) {
  const chatDiv = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = "system-msg";
  div.textContent = text;
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}
</script>

</body>
</html>
